{% extends "base.html" %}

{% block title %}Researcher Profile - Academic Network{% endblock %}

{% block content %}
    <div class="container mt-4">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="row">
                <div class="col-md-3 text-center">
                    <div class="profile-pic-container">
                        <img id="profile-pic" src="https://via.placeholder.com/200x200/6c757d/ffffff?text=Profile+Pic" 
                             alt="Profile Picture" class="profile-pic">
                        <button class="change-pic-btn" onclick="document.getElementById('profile-pic-input').click()">
                            <i class="fas fa-camera"></i>
                        </button>
                        <input type="file" id="profile-pic-input" accept="image/*" style="display: none;" 
                               onchange="changeProfilePic(this)">
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="profile-info">
                        <h1 id="researcher-name">{{ researcher.first_name }} {{ researcher.last_name }}</h1>
                        <p class="title" id="researcher-title">{{ researcher.position or 'Position not specified' }}</p>
                        <p class="institution" id="researcher-institution">{{ researcher.institution or 'Institution not specified' }}</p>
                        {% if researcher.profile and researcher.profile.location %}
                        <p class="location" id="researcher-location">
                            <i class="fas fa-map-marker-alt me-1"></i>{{ researcher.profile.location }}
                        </p>
                        {% endif %}
                        <p class="bio" id="researcher-bio">
                            {% if researcher.profile and researcher.profile.bio %}
                                {{ researcher.profile.bio }}
                            {% else %}
                                No bio available. Click "Edit Profile" to add your bio.
                            {% endif %}
                        </p>
                        
                        <!-- Social Media Links -->
                        <div class="social-links">
                            {% if researcher.profile %}
                                {% for social in researcher.profile.socials %}
                                    {% if social.platform == 'LinkedIn' %}
                                        <a href="{{ social.url }}" class="social-link linkedin" target="_blank">
                                            <i class="fab fa-linkedin"></i> LinkedIn
                                        </a>
                                    {% elif social.platform == 'Twitter' %}
                                        <a href="{{ social.url }}" class="social-link twitter" target="_blank">
                                            <i class="fab fa-twitter"></i> Twitter
                                        </a>
                                    {% elif social.platform == 'Instagram' %}
                                        <a href="{{ social.url }}" class="social-link instagram" target="_blank">
                                            <i class="fab fa-instagram"></i> Instagram
                                        </a>
                                    {% elif social.platform == 'GitHub' %}
                                        <a href="{{ social.url }}" class="social-link github" target="_blank">
                                            <i class="fab fa-github"></i> GitHub
                                        </a>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Research Interests -->
        <div class="interests-section">
            <div class="section-header">
                <h2>Research Interests</h2>
                {% if is_owner %}
                <button class="btn btn-outline-primary btn-sm" onclick="editInterests()" id="edit-interests-btn">Edit</button>
                {% endif %}
            </div>
            <div class="interests-tags" id="research-interests">
                {% if researcher.profile and researcher.profile.research_interests and researcher.profile.research_interests.strip() %}
                    {% for interest in researcher.profile.research_interests.split(',') %}
                        {% if interest.strip() %}
                            <span class="interest-tag">{{ interest.strip() }}</span>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <span class="interest-tag">No interests selected yet</span>
                {% endif %}
            </div>
        </div>

        <!-- Profile Actions -->
        {% if is_owner %}
        <div class="profile-actions">
            <a href="{{ url_for('main.edit_profile') }}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit Profile
            </a>
            <button class="btn btn-success" onclick="addNewPaper()">
                <i class="fas fa-plus"></i> Add New Paper
            </button>
            <button class="btn btn-info" onclick="managePapers()">
                <i class="fas fa-file-alt"></i> Manage Papers
            </button>
        </div>
        {% endif %}

        <!-- Recent Papers -->
        <div class="papers-section">
            <div class="section-header">
                <h2>Recent Papers</h2>
                <button class="btn btn-outline-primary btn-sm" onclick="viewAllPapers()">View All</button>
            </div>
            <div class="papers-grid" id="recent-papers">
                <!-- Papers will be dynamically loaded here -->
            </div>
        </div>
        
        <!-- Logout Section -->
        <div class="logout-section text-center py-4">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="logout-card">
                            <h4 class="mb-3">Account Management</h4>
                            <p class="text-muted mb-4">Manage your account settings and logout when you're done.</p>
                            <a href="{{ url_for('auth.logout') }}" class="btn btn-danger btn-lg">
                                <i class="fas fa-sign-out-alt me-2"></i>Sign Out
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Custom Edit Interests Modal -->
    <div id="editInterestsModal" class="custom-modal" style="display: none;">
        <div class="custom-modal-overlay" onclick="closeModal()"></div>
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">Edit Research Interests</h5>
                <button type="button" class="custom-modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div class="mb-4">
                    <label class="form-label">Search and add research interests:</label>
                    <input type="text" class="form-control" id="interest-search" placeholder="Type to search through 500+ research interests across all academic disciplines...">
                    <small class="form-text text-muted">Type to search for interests, then click to add them. Click on selected interests below to remove them.</small>
                </div>
                
                <!-- Search Results -->
                <div class="search-results mb-4" id="search-results" style="display: none;">
                    <h6>Search Results:</h6>
                    <div id="search-results-list" class="search-results-container">
                        <!-- Search results will appear here -->
                    </div>
                </div>
                
                <!-- Selected Interests -->
                <div class="selected-interests">
                    <h6>Your Research Interests: <span id="selected-count" class="badge bg-success">0</span></h6>
                    <div id="selected-interests-list" class="selected-interests-container">
                        <!-- Selected interests will appear here -->
                    </div>
                    <small class="form-text text-muted mt-2">Click on any interest below to remove it from your profile.</small>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveInterests()">Save Interests</button>
            </div>
        </div>
    </div>

    <!-- Add Paper Modal -->
    <div class="modal fade" id="addPaperModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Paper</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-paper-form">
                        <div class="mb-3">
                            <label class="form-label">Paper Title *</label>
                            <input type="text" class="form-control" id="paper-title" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Authors *</label>
                                    <input type="text" class="form-control" id="paper-authors" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Publication Year *</label>
                                    <input type="number" class="form-control" id="paper-year" min="1900" max="2030" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Journal/Conference</label>
                                    <input type="text" class="form-control" id="paper-venue">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">DOI</label>
                                    <input type="text" class="form-control" id="paper-doi" placeholder="10.1000/...">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Abstract</label>
                            <textarea class="form-control" id="paper-abstract" rows="4"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Keywords</label>
                            <input type="text" class="form-control" id="paper-keywords" placeholder="Separate with commas">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">PDF File</label>
                            <input type="file" class="form-control" id="paper-pdf" accept=".pdf">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitPaper()">Add Paper</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
    <script>
        // Sample papers data
        const samplePapers = [
            {
                title: "Advanced Neural Network Architectures for Image Recognition",
                authors: "Smith, J., Johnson, A., Williams, B.",
                year: 2023,
                venue: "International Conference on Computer Vision",
                citations: 45,
                abstract: "This paper presents novel neural network architectures..."
            },
            {
                title: "Machine Learning Approaches to Big Data Analysis",
                authors: "Smith, J., Brown, C.",
                year: 2022,
                venue: "Journal of Machine Learning Research",
                citations: 32,
                abstract: "We explore various machine learning techniques..."
            },
            {
                title: "Deep Learning Applications in Natural Language Processing",
                authors: "Smith, J., Davis, E., Wilson, F.",
                year: 2021,
                venue: "Neural Information Processing Systems",
                citations: 67,
                abstract: "This research investigates the application of deep learning..."
            }
        ];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            loadRecentPapers();
            updateStats();
            
            // Setup button
            const editBtn = document.getElementById('edit-interests-btn');
            if (editBtn) {
                console.log('Edit button found, adding click listener');
                editBtn.addEventListener('click', function(e) {
                    console.log('Button clicked via event listener');
                    e.preventDefault();
                    editInterests();
                });
            } else {
                console.log('Edit button not found');
            }
        });

        // Load recent papers
        function loadRecentPapers() {
            const papersContainer = document.getElementById('recent-papers');
            papersContainer.innerHTML = '';
            
            samplePapers.forEach(paper => {
                const paperCard = createPaperCard(paper);
                papersContainer.appendChild(paperCard);
            });
        }

        // Create paper card
        function createPaperCard(paper) {
            const card = document.createElement('div');
            card.className = 'paper-card';
            card.innerHTML = `
                <h3>${paper.title}</h3>
                <p class="authors">${paper.authors}</p>
                <p class="venue">${paper.venue} (${paper.year})</p>
                <p class="citations"><i class="fas fa-quote-left"></i> ${paper.citations} citations</p>
                <p class="abstract">${paper.abstract}</p>
                <div class="paper-actions">
                    <button class="btn btn-sm btn-outline-primary">View Details</button>
                    <button class="btn btn-sm btn-outline-secondary">Download PDF</button>
                </div>
            `;
            return card;
        }

        // Update statistics
        function updateStats() {
            const papersCountEl = document.getElementById('papers-count');
            const citationsCountEl = document.getElementById('citations-count');
            if (papersCountEl) papersCountEl.textContent = samplePapers.length;
            if (citationsCountEl) {
                const totalCitations = samplePapers.reduce((sum, paper) => sum + paper.citations, 0);
                citationsCountEl.textContent = totalCitations.toLocaleString();
            }
        }

        // Change profile picture
        function changeProfilePic(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profile-pic').src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }


        // Add new paper
        function addNewPaper() {
            const modal = new bootstrap.Modal(document.getElementById('addPaperModal'));
            modal.show();
        }

        // Submit paper
        function submitPaper() {
            const title = document.getElementById('paper-title').value;
            const authors = document.getElementById('paper-authors').value;
            const year = document.getElementById('paper-year').value;
            const venue = document.getElementById('paper-venue').value;
            const doi = document.getElementById('paper-doi').value;
            const abstract = document.getElementById('paper-abstract').value;
            const keywords = document.getElementById('paper-keywords').value;

            if (!title || !authors || !year) {
                showNotification('Please fill in all required fields.', 'error');
                return;
            }

            // Create new paper object
            const newPaper = {
                title: title,
                authors: authors,
                year: parseInt(year),
                venue: venue,
                doi: doi,
                abstract: abstract,
                keywords: keywords,
                citations: 0
            };

            // Add to papers array
            samplePapers.unshift(newPaper);

            // Reload papers and update stats
            loadRecentPapers();
            updateStats();

            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('addPaperModal'));
            modal.hide();
            document.getElementById('add-paper-form').reset();

            showNotification('Paper added successfully!', 'success');
        }

        // Manage papers
        function managePapers() {
            showNotification('Paper management feature coming soon!', 'info');
        }

        // View all papers
        function viewAllPapers() {
            showNotification('Full papers list coming soon!', 'info');
        }

        // Research interests data
        const researchInterests = [
            'Machine Learning', 'Artificial Intelligence', 'Data Science', 'Deep Learning',
            'Neural Networks', 'Computer Vision', 'Natural Language Processing', 'Robotics',
            'Algorithm Design', 'Data Mining', 'Big Data', 'Statistics', 'Probability',
            'Optimization', 'Linear Algebra', 'Calculus', 'Discrete Mathematics',
            'Software Engineering', 'Computer Programming', 'Database Systems', 'Information Systems',
            'Cybersecurity', 'Cryptography', 'Network Security', 'Information Security',
            'Human-Computer Interaction', 'User Experience Design', 'Web Development',
            'Mobile Development', 'Cloud Computing', 'Distributed Systems', 'Operating Systems',
            'Computer Architecture', 'Embedded Systems', 'IoT', 'Blockchain', 'Quantum Computing',
            'Bioinformatics', 'Computational Biology', 'Digital Signal Processing',
            'Image Processing', 'Pattern Recognition', 'Computer Graphics', 'Game Development',
            'Virtual Reality', 'Augmented Reality', 'Mixed Reality', 'Computer Animation',
            'Scientific Computing', 'High Performance Computing', 'Parallel Computing',
            'Machine Translation', 'Speech Recognition', 'Text Mining', 'Information Retrieval',
            'Recommender Systems', 'Social Network Analysis', 'Graph Theory', 'Complexity Theory',
            'Automata Theory', 'Formal Methods', 'Software Testing', 'Quality Assurance',
            'Project Management', 'Agile Development', 'DevOps', 'Microservices',
            'API Development', 'RESTful Services', 'GraphQL', 'Web Services',
            'Data Visualization', 'Business Intelligence', 'Analytics', 'Predictive Modeling',
            'Time Series Analysis', 'Regression Analysis', 'Classification', 'Clustering',
            'Dimensionality Reduction', 'Feature Engineering', 'Model Selection',
            'Cross-Validation', 'Hyperparameter Tuning', 'Ensemble Methods',
            'Reinforcement Learning', 'Transfer Learning', 'Federated Learning',
            'Explainable AI', 'Ethical AI', 'AI Ethics', 'Fairness in AI',
            'Bias in AI', 'AI Safety', 'Robust AI', 'Adversarial AI',
            'Generative AI', 'Large Language Models', 'Transformers', 'BERT', 'GPT',
            'Computer Networks', 'Internet Protocols', 'Wireless Networks', '5G',
            'Edge Computing', 'Fog Computing', 'Serverless Computing', 'Containerization',
            'Docker', 'Kubernetes', 'Infrastructure as Code', 'Configuration Management',
            'Version Control', 'Git', 'Continuous Integration', 'Continuous Deployment',
            'Monitoring', 'Logging', 'Debugging', 'Performance Optimization',
            'Scalability', 'Reliability', 'Fault Tolerance', 'Load Balancing',
            'Caching', 'CDN', 'Content Delivery', 'API Gateway', 'Service Mesh',
            'Event-Driven Architecture', 'Message Queues', 'Event Streaming',
            'Data Pipelines', 'ETL', 'Data Warehousing', 'Data Lakes',
            'Real-time Processing', 'Stream Processing', 'Batch Processing',
            'Data Governance', 'Data Privacy', 'GDPR', 'Compliance',
            'Risk Management', 'Audit', 'Logging', 'Compliance Monitoring',
            'Machine Learning Operations', 'MLOps', 'Model Deployment', 'Model Monitoring',
            'A/B Testing', 'Experimentation', 'Statistical Testing', 'Hypothesis Testing',
            
            // Physical Sciences
            'Physics', 'Quantum Physics', 'Theoretical Physics', 'Experimental Physics',
            'Astrophysics', 'Cosmology', 'Particle Physics', 'Nuclear Physics',
            'Materials Science', 'Nanotechnology', 'Chemistry', 'Organic Chemistry',
            'Inorganic Chemistry', 'Physical Chemistry', 'Biochemistry', 'Chemical Engineering',
            'Earth Sciences', 'Geology', 'Geophysics', 'Astronomy', 'Planetary Science',
            'Environmental Science', 'Climate Change', 'Ecology', 'Conservation Biology',
            
            // Life Sciences & Medicine
            'Biology', 'Molecular Biology', 'Cell Biology', 'Genetics', 'Genomics',
            'Neuroscience', 'Psychology', 'Medicine', 'Clinical Research', 'Public Health',
            'Cancer Research', 'Pharmacology', 'Epidemiology', 'Biomedical Engineering',
            'Nutrition Science', 'Agricultural Science', 'Veterinary Science',
            
            // Mathematics & Statistics
            'Mathematics', 'Pure Mathematics', 'Applied Mathematics', 'Algebra',
            'Geometry', 'Calculus', 'Probability Theory', 'Mathematical Statistics',
            'Optimization Theory', 'Game Theory', 'Mathematical Modeling',
            
            // Engineering
            'Engineering', 'Mechanical Engineering', 'Civil Engineering', 'Electrical Engineering',
            'Aerospace Engineering', 'Environmental Engineering', 'Materials Engineering',
            'Renewable Energy', 'Robotics Engineering', 'Biotechnology',
            
            // Social Sciences
            'Sociology', 'Political Science', 'International Relations', 'Economics',
            'Anthropology', 'Archaeology', 'Geography', 'Urban Planning',
            'Criminology', 'Criminal Justice', 'Public Policy',
            
            // Humanities
            'History', 'Literature', 'Philosophy', 'Linguistics', 'Art', 'Music',
            'Religious Studies', 'Cultural Studies', 'Media Studies',
            
            // Education
            'Education', 'Educational Psychology', 'Learning Sciences', 'Curriculum Studies',
            'Educational Technology', 'Higher Education', 'Teacher Education',
            
            // Business & Management
            'Business Administration', 'Management', 'Marketing', 'Finance',
            'Entrepreneurship', 'International Business', 'Human Resource Management',
            
            // Law & Legal Studies
            'Law', 'Constitutional Law', 'Criminal Law', 'International Law',
            'Intellectual Property Law', 'Environmental Law', 'Legal Studies',
            
            // Research Methods & Skills
            'Research Methodology', 'Experimental Design', 'Survey Design',
            'Qualitative Research', 'Quantitative Research', 'Mixed Methods Research',
            'Academic Writing', 'Technical Writing', 'Grant Writing', 'Teaching',
            'Presentation Skills', 'Public Speaking', 'Mentoring', 'Collaboration',
            'Project Management', 'Innovation', 'Creativity', 'Problem Solving',
            'Critical Thinking', 'Analytical Skills', 'Research Skills',
            'Literature Review', 'Funding', 'Communication', 'Leadership'
        ];

        let selectedInterests = [];
        let availableInterests = [...researchInterests];

        // Test function - can be called from browser console
        function testModal() {
            console.log('Testing modal...');
            const modalElement = document.getElementById('editInterestsModal');
            if (modalElement) {
                console.log('Modal element found');
                modalElement.style.display = 'flex';
                console.log('Modal should be showing');
            } else {
                console.error('Modal element not found');
            }
        }

        // Show custom modal
        function showModal() {
            const modal = document.getElementById('editInterestsModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
        }

        // Close custom modal
        function closeModal() {
            const modal = document.getElementById('editInterestsModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
        }

        // Edit interests
        function editInterests() {
            console.log('Edit interests clicked');
            
            try {
                // Get current interests from the page
                const currentInterests = [];
                const interestTags = document.querySelectorAll('#research-interests .interest-tag');
                interestTags.forEach(tag => {
                    const interest = tag.textContent.trim();
                    // Skip the placeholder text
                    if (interest !== 'No interests selected yet') {
                        currentInterests.push(interest);
                    }
                });
                
                console.log('Current interests from page:', currentInterests);
                
                selectedInterests = [...currentInterests];
                availableInterests = researchInterests.filter(interest => 
                    !selectedInterests.includes(interest)
                );
                
                console.log('Selected interests:', selectedInterests);
                console.log('Available interests count:', availableInterests.length);
                
                updateInterestsDisplay();
                
                // Clear search input
                const searchInput = document.getElementById('interest-search');
                if (searchInput) {
                    searchInput.value = '';
                }
                
                initializeSearch();
                
                // Show modal
                showModal();
                console.log('Modal should be showing now');
                
            } catch (error) {
                console.error('Error in editInterests:', error);
                alert('Error opening interests editor: ' + error.message);
            }
        }

        // Update interests display in modal
        function updateInterestsDisplay() {
            console.log('Updating interests display');
            const selectedContainer = document.getElementById('selected-interests-list');
            
            if (!selectedContainer) {
                console.error('Selected container not found');
                return;
            }
            
            // Clear selected container
            selectedContainer.innerHTML = '';
            
            console.log('Adding selected interests:', selectedInterests.length);
            // Add selected interests
            selectedInterests.forEach(interest => {
                const tag = document.createElement('span');
                tag.className = 'interest-tag selected-tag';
                tag.textContent = interest;
                tag.onclick = () => removeInterest(interest);
                selectedContainer.appendChild(tag);
            });
            
            // Update counter
            const counter = document.getElementById('selected-count');
            if (counter) {
                counter.textContent = selectedInterests.length;
            }
        }

        // Update search results
        function updateSearchResults(searchTerm) {
            const searchResultsDiv = document.getElementById('search-results');
            const searchResultsList = document.getElementById('search-results-list');
            
            if (!searchResultsDiv || !searchResultsList) {
                console.error('Search results elements not found');
                return;
            }
            
            // Clear previous results
            searchResultsList.innerHTML = '';
            
            if (searchTerm.length < 2) {
                searchResultsDiv.style.display = 'none';
                return;
            }
            
            // Filter interests based on search term
            const filteredInterests = researchInterests.filter(interest => 
                interest.toLowerCase().includes(searchTerm.toLowerCase()) &&
                !selectedInterests.includes(interest)
            );
            
            if (filteredInterests.length === 0) {
                searchResultsDiv.style.display = 'none';
                return;
            }
            
            // Show search results
            searchResultsDiv.style.display = 'block';
            
            // Add filtered interests
            filteredInterests.slice(0, 20).forEach(interest => { // Limit to 20 results
                const tag = document.createElement('span');
                tag.className = 'interest-tag available-tag';
                tag.textContent = interest;
                tag.onclick = () => addInterest(interest);
                searchResultsList.appendChild(tag);
            });
            
            if (filteredInterests.length > 20) {
                const moreTag = document.createElement('span');
                moreTag.className = 'interest-tag more-results';
                moreTag.textContent = `... and ${filteredInterests.length - 20} more`;
                moreTag.style.fontStyle = 'italic';
                moreTag.style.opacity = '0.7';
                searchResultsList.appendChild(moreTag);
            }
        }

        // Add interest
        function addInterest(interest) {
            console.log('Adding interest:', interest);
            if (!selectedInterests.includes(interest)) {
                selectedInterests.push(interest);
                updateInterestsDisplay();
                
                // Update search results to remove the added interest
                const searchInput = document.getElementById('interest-search');
                if (searchInput) {
                    updateSearchResults(searchInput.value);
                }
            }
        }

        // Remove interest
        function removeInterest(interest) {
            console.log('Removing interest:', interest);
            selectedInterests = selectedInterests.filter(i => i !== interest);
            updateInterestsDisplay();
            
            // Update search results to show the removed interest again
            const searchInput = document.getElementById('interest-search');
            if (searchInput) {
                updateSearchResults(searchInput.value);
            }
        }

        // Save interests
        function saveInterests() {
            console.log('Saving interests:', selectedInterests);
            
            // Update the page display
            const interestsContainer = document.getElementById('research-interests');
            interestsContainer.innerHTML = '';
            
            if (selectedInterests.length === 0) {
                const tag = document.createElement('span');
                tag.className = 'interest-tag';
                tag.textContent = 'No interests selected yet';
                interestsContainer.appendChild(tag);
            } else {
                selectedInterests.forEach(interest => {
                    const tag = document.createElement('span');
                    tag.className = 'interest-tag';
                    tag.textContent = interest;
                    interestsContainer.appendChild(tag);
                });
            }
            
            // Send to server
            const interestsString = selectedInterests.join(',');
            console.log('Sending to server:', interestsString);
            
            fetch('/update-interests', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    interests: interestsString
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Server response:', data);
                if (data.success) {
                    showNotification('Research interests updated successfully!', 'success');
                    closeModal();
                } else {
                    showNotification('Error updating interests. Please try again.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error updating interests. Please try again.', 'error');
            });
        }

        // Initialize search functionality when modal is shown
        function initializeSearch() {
            const searchInput = document.getElementById('interest-search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value;
                    updateSearchResults(searchTerm);
                });
            }
        }

        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;

            // Add to page
            document.body.appendChild(notification);

            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
{% endblock %}
