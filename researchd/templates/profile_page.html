{% extends "base.html" %}

{% block title %}Researcher Profile - Academic Network{% endblock %}

{% block content %}
    <div class="container mt-4" id="profile-sections">
        {% for s in section_order %}
        {% if s.section == 'profile-header' %}
        <!-- Profile Header -->
        <div class="profile-header {% if not s.visible %}d-none{% endif %}">
            <div class="profile-section" data-section="profile-header">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="profile-pic-container">
                            <img id="profile-pic" src="{{ url_for('static', filename='placeholder.png') }}" 
                                alt="Profile Picture" class="profile-pic">
                            <button class="change-pic-btn" onclick="document.getElementById('profile-pic-input').click()">
                                <i class="fas fa-camera"></i>
                            </button>
                            <input type="file" id="profile-pic-input" accept="image/*" style="display: none;" 
                                onchange="changeProfilePic(this)">
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="profile-info">
                            <h1 id="researcher-name">{{ profile.user.first_name }} {{ profile.user.last_name }}</h1>
                            <p class="title" id="researcher-title">{{ profile.position or 'Position not specified' }}</p>
                            <p class="institution" id="researcher-institution">{{ profile.institution or 'Institution not specified' }}</p>
                            {% if profile.location %}
                            <p class="location" id="researcher-location">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ profile.location }}
                            </p>
                            {% endif %}
                            <p class="bio" id="researcher-bio">
                                {% if profile.bio %}
                                    {{ profile.bio }}
                                {% else %}
                                    No bio available. Click "Edit Profile" to add your bio.
                                {% endif %}
                            </p>
                            
                            <!-- Social Media Links -->
                            <div class="social-links">
                                {% for social in profile.socials %}
                                        {% if social.platform == 'LinkedIn' %}
                                            <a href="{{ social.url }}" class="social-link linkedin" target="_blank">
                                                <i class="fab fa-linkedin"></i> LinkedIn
                                            </a>
                                        {% elif social.platform == 'Twitter' %}
                                            <a href="{{ social.url }}" class="social-link twitter" target="_blank">
                                                <i class="fab fa-twitter"></i> Twitter
                                            </a>
                                        {% elif social.platform == 'Instagram' %}
                                            <a href="{{ social.url }}" class="social-link instagram" target="_blank">
                                                <i class="fab fa-instagram"></i> Instagram
                                            </a>
                                        {% elif social.platform == 'GitHub' %}
                                            <a href="{{ social.url }}" class="social-link github" target="_blank">
                                                <i class="fab fa-github"></i> GitHub
                                            </a>
                                        {% endif %}
                                    {% endfor %}
                                    
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        {% elif s.section == 'interests-section' %}
        <!-- Research Interests -->
        <div class="interests-section {% if not s.visible %}d-none{% endif %}" id="interests-section">
            <div class="profile-section" data-section="interests-section">
                <div class="section-header">
                    <h2>Research Interests</h2>
                    {% if is_owner %}
                    <button class="btn btn-outline-primary btn-sm" onclick="editInterests()" id="edit-interests-btn">Edit</button>
                    {% endif %}
                </div>
                <div class="interests-tags" id="research-interests">
                    {% if profile.research_interests and profile.research_interests.strip() %}
                        {% for interest in profile.research_interests.split(',') %}
                            {% if interest.strip() %}
                                <span class="interest-tag">{{ interest.strip() }}</span>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="interest-tag">No interests selected yet</span>
                    {% endif %}
                </div>
            </div>
        </div>

        {% elif s.section == 'papers-section' %}

        <!-- Recent Papers -->
        <div class="papers-section {% if not s.visible %}d-none{% endif %}" id="papers-section">
            <div class="profile-section" data-section="papers-section">
                <div class="section-header">
                    <h2>Recent Papers</h2>
                    {% if publications %}
                    <a href="{{ url_for('main.my_papers') }}" class="btn btn-outline-primary btn-sm">View All</a>
                    {% endif %}
                </div>
                <div class="papers-grid" id="recent-papers">
                    {% if publications %}
                        {% for publication in publications %}
                        <div class="paper-card">
                            <h3>{{ publication.title[:60] }}{% if publication.title|length > 60 %}...{% endif %}</h3>
                            {% if publication.authors %}
                            <p class="authors">{{ publication.authors[:80] }}{% if publication.authors|length > 80 %}...{% endif %}</p>
                            {% endif %}
                            {% if publication.journal and publication.year %}
                            <p class="venue">{{ publication.journal }} ({{ publication.year }})</p>
                            {% elif publication.year %}
                            <p class="venue">{{ publication.year }}</p>
                            {% endif %}
                            {% if publication.abstract %}
                            <p class="abstract">{{ publication.abstract[:150] }}{% if publication.abstract|length > 150 %}...{% endif %}</p>
                            {% endif %}
                            <div class="paper-actions">
                                {% if publication.file %}
                                <a href="{{ url_for('main.download_file', filename=publication.file.file_path) }}" 
                                class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="fas fa-download me-1"></i>Download PDF
                                </a>
                                {% endif %}
                                {% if publication.url %}
                                <a href="{{ publication.url }}" class="btn btn-sm btn-outline-secondary" target="_blank">
                                    <i class="fas fa-external-link-alt me-1"></i>View Online
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-papers">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No papers uploaded yet</h5>
                            {% if is_owner %}
                            <p class="text-muted">Start sharing your research by uploading your first paper!</p>
                            <a href="{{ url_for('main.upload_paper') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Upload Your First Paper
                            </a>
                            {% else %}
                            <p class="text-muted">This researcher hasn't uploaded any papers yet.</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}

        <!-- Profile Actions -->
        {% if is_owner %}
        <div class="profile-actions">
            <a href="{{ url_for('main.edit_profile') }}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit Profile
            </a>
            <a href="{{ url_for('main.upload_paper') }}" class="btn btn-success">
                <i class="fas fa-plus"></i> Upload New Paper
            </a>
            <a href="{{ url_for('main.my_papers') }}" class="btn btn-info">
                <i class="fas fa-file-alt"></i> View My Papers
            </a>
            <button class="btn btn-outline-primary" onclick="toggleExternalRoles()" id="toggle-external-roles-btn">
                <i class="fas fa-users me-1"></i> External Roles
            </button>
            <button class="btn btn-outline-primary" onclick="toggleAchievements()" id="toggle-achievements-btn">
                <i class="fas fa-trophy me-1"></i> Achievements
            </button>
            <button class="btn btn-primary" onclick="addSection('buttons_section')">Add Section</button>

        </div>
        <div id="buttons_section">
            {% set section_map = section_order | map(attribute='section') | list %}
            {% set visible_map = section_order | map(attribute='visible') | list %}
            {% for s in section_order %}
                {% if s.section == 'papers-section' %}
                    {% if not s.visible %}
                        <button class="btn btn-primary" onclick="addSection('papers-section')">Add Papers Section</button>
                    {% else %}
                        <button type="button" class="btn btn-primary" onclick="deleteSection('papers-section')">Delete Papers Section</button>
                    {% endif %}
                {% elif s.section == 'interests-section' %}
                    {% if not s.visible %}
                        <button class="btn btn-primary" onclick="addSection('interests-section')">Add Interests Section</button>
                    {% else %}
                        <button type="button" class="btn btn-primary" onclick="deleteSection('interests-section')">Delete Interests Section</button>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
        
        <!-- External Positions / Roles (placed under buttons section) -->
        <div class="papers-section external-roles-section mt-4" id="external-roles-section" style="display: none;">
            <div class="profile-section" data-section="external-roles-section">
                <div class="section-header">
                    <h2><i class="fas fa-users me-2"></i>External Roles</h2>
                    {% if is_owner %}
                    <div>
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="addExternalRoleWithModal()">
                            <i class="fas fa-plus me-1"></i>Add Role
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleExternalRoles()">
                            <i class="fas fa-eye-slash me-1"></i>Hide
                        </button>
                    </div>
                    {% endif %}
                </div>

                <div id="external-roles-list" class="list-group">
                    {% if external_roles %}
                        {% for er in external_roles %}
                        <div class="list-group-item d-flex justify-content-between align-items-center" data-erid="{{ er.erid }}" style="cursor: move;">
                            <div>
                                <strong>{{ er.role_title }}</strong> — {{ er.organization }}
                                {% if er.start_year %}
                                    <small>({{ er.start_year }}{% if er.end_year %} – {{ er.end_year }}{% else %} – Present{% endif %})</small>
                                {% endif %}
                                {% if er.description %}
                                    <p class="mb-0 text-muted">{{ er.description }}</p>
                                {% endif %}
                            </div>
                            {% if is_owner %}
                            <div>
                                <button class="btn btn-sm btn-danger" onclick="deleteExternalRole(Number(this.closest('[data-erid]').dataset.erid))" title="Delete this role">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% if is_owner and external_roles|length > 1 %}
                        <small class="text-muted mt-2 d-block drag-instructions-external">
                            <i class="fas fa-grip-vertical me-1"></i>Drag and drop to reorder roles
                        </small>
                        {% endif %}
                    {% else %}
                        <div class="empty-state">
                            <h5 class="text-muted">No external positions added yet</h5>
                            {% if is_owner %}
                            <p class="text-muted">Showcase roles like editorial boards, society offices, visiting appointments, etc.</p>
                            <button class="btn btn-primary" onclick="addExternalRoleWithModal()">
                                <i class="fas fa-plus me-2"></i>Add Your First Role
                            </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Achievements Section -->
        <div class="papers-section achievements-section mt-4 {% if profile.achievements %}d-block{% else %}d-none{% endif %}" id="achievements-section">
            <div class="profile-section" data-section="achievements-section">
                <div class="section-header">
                    <h2><i class="fas fa-trophy me-2"></i>Achievements</h2>
                    {% if is_owner %}
                    <div>
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="addAchievementWithModal()">
                            <i class="fas fa-plus me-1"></i>Add Achievement
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleAchievements()">
                            <i class="fas fa-eye-slash me-1"></i>Hide
                        </button>
                    </div>
                    {% endif %}
                </div>

                <div id="achievements-list" class="list-group">
                    {% if profile.achievements %}
                        {% for ach in profile.achievements %}
                        <div class="list-group-item d-flex justify-content-between align-items-center" data-achid="{{ ach.achid }}" style="cursor: move;">
                            <div>
                                <strong>{{ ach.title }}</strong>
                                {% if ach.type %}<span class="badge bg-secondary">{{ ach.type }}</span>{% endif %}
                                {% if ach.year %}<small class="text-muted">({{ ach.year }})</small>{% endif %}
                                {% if ach.description %}
                                    <p class="mb-0 text-muted">{{ ach.description }}</p>
                                {% endif %}
                            </div>
                            {% if is_owner %}
                            <div>
                                <button class="btn btn-sm btn-danger" onclick="deleteAchievement('{{ ach.aid }}')" title="Delete this achievement">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}

                        {% if is_owner and profile.achievements|length > 1 %}
                        <small class="text-muted mt-2 d-block drag-instructions-achievements">
                            <i class="fas fa-grip-vertical me-1"></i>Drag and drop to reorder achievements
                        </small>
                        {% endif %}

                    {% else %}
                        <div class="empty-state">
                            <h5 class="text-muted">No achievements added yet</h5>
                            {% if is_owner %}
                            <p class="text-muted">Add your awards, grants, recognitions, and honors here.</p>
                            <button class="btn btn-primary" onclick="addAchievementWithModal()">
                                <i class="fas fa-plus me-2"></i>Add Your First Achievement
                            </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


       {% if is_owner %} 
        <!-- Logout Section -->
        <div class="logout-section text-center py-4">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="logout-card">
                            <h4 class="mb-3">Account Management</h4>
                            <p class="text-muted mb-4">Manage your account settings and logout when you're done.</p>
                            <a href="{{ url_for('auth.logout') }}" class="btn btn-danger btn-lg">
                                <i class="fas fa-sign-out-alt me-2"></i>Sign Out
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}


    <!-- Modals -->

    <!-- Custom Edit Interests Modal -->
    <div id="editInterestsModal" class="custom-modal" style="display: none;">
        <div class="custom-modal-overlay" onclick="closeModal()"></div>
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">Edit Research Interests</h5>
                <button type="button" class="custom-modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div class="mb-4">
                    <label class="form-label">Search and add research interests:</label>
                    <input type="text" class="form-control" id="interest-search" placeholder="Type to search through 500+ research interests across all academic disciplines...">
                    <small class="form-text text-muted">Type to search for interests, then click to add them. Click on selected interests below to remove them.</small>
                </div>
                
                <!-- Search Results -->
                <div class="search-results mb-4" id="search-results" style="display: none;">
                    <h6>Search Results:</h6>
                    <div id="search-results-list" class="search-results-container">
                        <!-- Search results will appear here -->
                    </div>
                </div>
                
                <!-- Selected Interests -->
                <div class="selected-interests">
                    <h6>Your Research Interests: <span id="selected-count" class="badge bg-success">0</span></h6>
                    <div id="selected-interests-list" class="selected-interests-container">
                        <!-- Selected interests will appear here -->
                    </div>
                    <small class="form-text text-muted mt-2">Click on any interest below to remove it from your profile.</small>
                </div>
            </div>
            <div class="custom-modal-footer" style="display:none;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveInterests()">Save Interests</button>
            </div>
        </div>
    </div>

    <!-- Add Paper Modal -->
    <div class="modal fade" id="addPaperModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Paper</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-paper-form">
                        <div class="mb-3">
                            <label class="form-label">Paper Title *</label>
                            <input type="text" class="form-control" id="paper-title" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Authors *</label>
                                    <input type="text" class="form-control" id="paper-authors" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Publication Year *</label>
                                    <input type="number" class="form-control" id="paper-year" min="1900" max="2030" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Journal/Conference</label>
                                    <input type="text" class="form-control" id="paper-venue">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">DOI</label>
                                    <input type="text" class="form-control" id="paper-doi" placeholder="10.1000/...">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Abstract</label>
                            <textarea class="form-control" id="paper-abstract" rows="4"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Keywords</label>
                            <input type="text" class="form-control" id="paper-keywords" placeholder="Separate with commas">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">PDF File</label>
                            <input type="file" class="form-control" id="paper-pdf" accept=".pdf">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitPaper()">Add Paper</button>
                </div>
            </div>
        </div>
    </div>
    <!-- End of Modals -->
    <script>
        function addSection(sect) {
            console.log("Button has")
            const section = document.querySelector(`.profile-section[data-section="${sect}"]`);
            if (section) {
                section.parentElement.style.display = "";
                toggleSectionButtons(sect, true);
                saveSectionOrder();
            }
        }

        function deleteSection(sect) {
            const section = document.querySelector(`.profile-section[data-section="${sect}"]`);
            if (section) {
                section.parentElement.style.display = "none";
                toggleSectionButtons(sect, false);
                saveSectionOrder();
            }
        }

        function toggleSectionButtons(sect, isVisible) {
            const addBtn = document.querySelector(`#buttons_section .btn[data-add-section="${sect}"]`);
            const delBtn = document.querySelector(`#buttons_section .btn[data-del-section="${sect}"]`);
            if (addBtn) addBtn.style.display = isVisible ? "none" : "";
            if (delBtn) delBtn.style.display = isVisible ? "" : "none";
        }

        function saveSectionOrder() {
            let order = [];
            document.querySelectorAll('#profile-sections .profile-section').forEach(function(section) {
                order.push({
                    section: section.getAttribute('data-section'),
                    visible: section.parentElement.style.display !== 'none'
                });
            });
            fetch('/save-section-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({order: order})
            });
        }

        function toggleExternalRoles() {
            const externalSection = document.getElementById('external-roles-section');
            const toggleBtn = document.getElementById('toggle-external-roles-btn');
            
            if (externalSection.style.display === 'none') {
                externalSection.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash me-1"></i> Hide External Roles';
                toggleBtn.classList.remove('btn-outline-primary');
                toggleBtn.classList.add('btn-outline-secondary');
            } else {
                externalSection.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-users me-1"></i> External Roles';
                toggleBtn.classList.remove('btn-outline-secondary');
                toggleBtn.classList.add('btn-outline-primary');
            }
        }

        function toggleAchievements() {
            const achievementSection = document.getElementById('achievements-section');
            const toggleBtn = document.getElementById('toggle-achievements-btn');

            achievementSection.classList.toggle('d-none');

            if (achievementSection.classList.contains('d-none')) {
                toggleBtn.innerHTML = '<i class="fas fa-trophy me-1"></i> Achievements';
                toggleBtn.classList.remove('btn-outline-secondary');
                toggleBtn.classList.add('btn-outline-primary');
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash me-1"></i> Hide Achievements';
                toggleBtn.classList.remove('btn-outline-primary');
                toggleBtn.classList.add('btn-outline-secondary');
            }
        }


        function deleteAchievement(aid) {
            fetch(`/delete_achievement/${aid}`, { method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const el = document.querySelector(`[data-achid="${aid}"]`);
                        if (el) el.remove();
                            showNotification('Achievement deleted successfully', 'success');
                    } else {
                      showNotification('Error deleting achievement', 'error');
                  }
              })
              .catch(() => {
                  showNotification('Error deleting achievement', 'error');
              });
        }
  </script>

{% endblock %}

{% block extra_js %}
    {% if is_owner%}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            new Sortable(document.getElementById('profile-sections'), {
                animation: 150,
                handle: '.profile-section',
                onEnd: function (evt) {
                    saveSectionOrder();
                }
            });

            // Initialize sortable for External Roles list if present
            const extList = document.getElementById('external-roles-list');
            if (extList) {
                new Sortable(extList, {
                    animation: 150,
                    handle: '.list-group-item',
                    onEnd: function () {
                        const order = Array.from(extList.children)
                            .filter(item => item.dataset.erid)
                            .map(item => item.dataset.erid);
                        fetch('/update_external_role_order', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ order: order })
                        }).then(r => r.json()).then(data => {
                            if (data.success) {
                                showNotification('External roles order updated!', 'success');
                            } else {
                                showNotification('Error updating roles order', 'error');
                            }
                        });
                    }
                });
            }
        });
    </script>
    {% endif %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // User publications are now loaded dynamically from the server

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            
            // Setup button
            const editBtn = document.getElementById('edit-interests-btn');
            if (editBtn) {
                console.log('Edit button found, adding click listener');
                editBtn.addEventListener('click', function(e) {
                    console.log('Button clicked via event listener');
                    e.preventDefault();
                    editInterests();
                });
            } else {
                console.log('Edit button not found');
            }
        });

        // Papers are now loaded dynamically from the server via Jinja2 templates

        // Statistics are now handled by the server-rendered template

        // Change profile picture
        function changeProfilePic(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profile-pic').src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }


        // External Roles - Modal create
        function addExternalRoleWithModal() {
            const modalHTML = `
                <div id="addExternalRoleModal" class="custom-modal" style="display: flex;">
                    <div class="custom-modal-overlay" onclick="closeExternalRoleModal()"></div>
                    <div class="custom-modal-content">
                        <div class="custom-modal-header">
                            <h5 class="custom-modal-title"><i class="fas fa-users me-2"></i>Add External Role</h5>
                            <button type="button" class="custom-modal-close" onclick="closeExternalRoleModal()">&times;</button>
                        </div>
                        <div class="custom-modal-body">
                            <form id="external-role-form">
                                <div class="mb-3">
                                    <label class="form-label">Role/Title *</label>
                                    <input type="text" class="form-control" id="er-role-title" required placeholder="e.g., Editorial Board Member">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Organisation *</label>
                                    <input type="text" class="form-control" id="er-organization" required placeholder="e.g., Journal of X, ACM SIGY">
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Start Year</label>
                                            <input type="number" class="form-control" id="er-start-year" min="1900" max="2035">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">End Year</label>
                                            <input type="number" class="form-control" id="er-end-year" min="1900" max="2035">
                                            <small class="form-text text-muted">Leave empty if current</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="er-description" rows="3" placeholder="Optional short description..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="custom-modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeExternalRoleModal()">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitExternalRole()">Add Role</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                const input = document.getElementById('er-role-title');
                if (input) input.focus();
            }, 100);
        }

        function closeExternalRoleModal() {
            const modal = document.getElementById('addExternalRoleModal');
            if (modal) modal.remove();
            document.body.style.overflow = 'auto';
        }

        function submitExternalRole() {
            const roleTitle = document.getElementById('er-role-title').value.trim();
            const organization = document.getElementById('er-organization').value.trim();
            const startYear = document.getElementById('er-start-year').value;
            const endYear = document.getElementById('er-end-year').value;
            const description = document.getElementById('er-description').value.trim();

            if (!roleTitle || !organization) {
                showNotification('Please fill in required fields (Role and Organization)', 'error');
                return;
            }

            const submitBtn = document.querySelector('#addExternalRoleModal .btn-primary');
            if (submitBtn) { submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...'; submitBtn.disabled = true; }

            fetch('/add_external_role', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    role_title: roleTitle,
                    organization: organization,
                    start_year: startYear ? parseInt(startYear) : null,
                    end_year: endYear ? parseInt(endYear) : null,
                    description: description
                })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    addExternalRoleToDOM(result);
                    closeExternalRoleModal();
                    showNotification('External role added!', 'success');
                } else {
                    showNotification('Error adding role: ' + (result.error || 'Unknown error'), 'error');
                }
            })
            .catch(err => {
                console.error(err);
                showNotification('Error adding role', 'error');
            })
            .finally(() => {
                if (submitBtn) { submitBtn.innerHTML = 'Add Role'; submitBtn.disabled = false; }
            });
        }

        function addExternalRoleToDOM(er) {
            const list = document.getElementById('external-roles-list');
            if (!list) return;

            const emptyState = list.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const div = document.createElement('div');
            div.className = 'list-group-item d-flex justify-content-between align-items-center';
            div.dataset.erid = er.erid;
            div.style.cursor = 'move';

            let yearRange = '';
            if (er.start_year) {
                yearRange = `<small>(${er.start_year}${er.end_year ? ' – ' + er.end_year : ' – Present'})</small>`;
            }

            div.innerHTML = `
                <div>
                    <strong>${escapeHtml(er.role_title)}</strong> — ${escapeHtml(er.organization)}
                    ${yearRange}
                    ${er.description ? `<p class="mb-0 text-muted">${escapeHtml(er.description)}</p>` : ''}
                </div>
                <div>
                    <button class="btn btn-sm btn-danger" onclick="deleteExternalRole(${er.erid})" title="Delete this role">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            list.appendChild(div);

            const instructions = document.querySelector('.drag-instructions-external');
            if (!instructions && list.children.length > 1) {
                const small = document.createElement('small');
                small.className = 'text-muted mt-2 d-block drag-instructions-external';
                small.innerHTML = '<i class="fas fa-grip-vertical me-1"></i>Drag and drop to reorder roles';
                list.parentNode.appendChild(small);
            }
        }

        function deleteExternalRole(erid) {
            fetch(`/delete_external_role/${erid}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const el = document.querySelector(`[data-erid="${erid}"]`);
                        if (el) el.remove();
                        showNotification('External role deleted', 'success');
                    } else {
                        showNotification('Error deleting role', 'error');
                    }
                })
                .catch(() => showNotification('Error deleting role', 'error'));
        }

        // Reuse escapeHtml from interests section if present; otherwise define it here
        if (typeof escapeHtml !== 'function') {
            function escapeHtml(text) {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return String(text).replace(/[&<>"']/g, m => map[m]);
            }
        }

        // Paper management functions now redirect to dedicated upload page
        function addNewPaper() {
            window.location.href = "{{ url_for('main.upload_paper') }}";
        }

        // Manage papers
        function managePapers() {
            showNotification('Paper management feature coming soon!', 'info');
        }

        // View all papers
        function viewAllPapers() {
            window.location.href = "{{ url_for('main.my_papers') }}";
        }

        // Research interests data
        const researchInterests = [
            'Machine Learning', 'Artificial Intelligence', 'Data Science', 'Deep Learning',
            'Neural Networks', 'Computer Vision', 'Natural Language Processing', 'Robotics',
            'Algorithm Design', 'Data Mining', 'Big Data', 'Statistics', 'Probability',
            'Optimization', 'Linear Algebra', 'Calculus', 'Discrete Mathematics',
            'Software Engineering', 'Computer Programming', 'Database Systems', 'Information Systems',
            'Cybersecurity', 'Cryptography', 'Network Security', 'Information Security',
            'Human-Computer Interaction', 'User Experience Design', 'Web Development',
            'Mobile Development', 'Cloud Computing', 'Distributed Systems', 'Operating Systems',
            'Computer Architecture', 'Embedded Systems', 'IoT', 'Blockchain', 'Quantum Computing',
            'Bioinformatics', 'Computational Biology', 'Digital Signal Processing',
            'Image Processing', 'Pattern Recognition', 'Computer Graphics', 'Game Development',
            'Virtual Reality', 'Augmented Reality', 'Mixed Reality', 'Computer Animation',
            'Scientific Computing', 'High Performance Computing', 'Parallel Computing',
            'Machine Translation', 'Speech Recognition', 'Text Mining', 'Information Retrieval',
            'Recommender Systems', 'Social Network Analysis', 'Graph Theory', 'Complexity Theory',
            'Automata Theory', 'Formal Methods', 'Software Testing', 'Quality Assurance',
            'Project Management', 'Agile Development', 'DevOps', 'Microservices',
            'API Development', 'RESTful Services', 'GraphQL', 'Web Services',
            'Data Visualization', 'Business Intelligence', 'Analytics', 'Predictive Modeling',
            'Time Series Analysis', 'Regression Analysis', 'Classification', 'Clustering',
            'Dimensionality Reduction', 'Feature Engineering', 'Model Selection',
            'Cross-Validation', 'Hyperparameter Tuning', 'Ensemble Methods',
            'Reinforcement Learning', 'Transfer Learning', 'Federated Learning',
            'Explainable AI', 'Ethical AI', 'AI Ethics', 'Fairness in AI',
            'Bias in AI', 'AI Safety', 'Robust AI', 'Adversarial AI',
            'Generative AI', 'Large Language Models', 'Transformers', 'BERT', 'GPT',
            'Computer Networks', 'Internet Protocols', 'Wireless Networks', '5G',
            'Edge Computing', 'Fog Computing', 'Serverless Computing', 'Containerization',
            'Docker', 'Kubernetes', 'Infrastructure as Code', 'Configuration Management',
            'Version Control', 'Git', 'Continuous Integration', 'Continuous Deployment',
            'Monitoring', 'Logging', 'Debugging', 'Performance Optimization',
            'Scalability', 'Reliability', 'Fault Tolerance', 'Load Balancing',
            'Caching', 'CDN', 'Content Delivery', 'API Gateway', 'Service Mesh',
            'Event-Driven Architecture', 'Message Queues', 'Event Streaming',
            'Data Pipelines', 'ETL', 'Data Warehousing', 'Data Lakes',
            'Real-time Processing', 'Stream Processing', 'Batch Processing',
            'Data Governance', 'Data Privacy', 'GDPR', 'Compliance',
            'Risk Management', 'Audit', 'Logging', 'Compliance Monitoring',
            'Machine Learning Operations', 'MLOps', 'Model Deployment', 'Model Monitoring',
            'A/B Testing', 'Experimentation', 'Statistical Testing', 'Hypothesis Testing',
            
            // Physical Sciences
            'Physics', 'Quantum Physics', 'Theoretical Physics', 'Experimental Physics',
            'Astrophysics', 'Cosmology', 'Particle Physics', 'Nuclear Physics',
            'Materials Science', 'Nanotechnology', 'Chemistry', 'Organic Chemistry',
            'Inorganic Chemistry', 'Physical Chemistry', 'Biochemistry', 'Chemical Engineering',
            'Earth Sciences', 'Geology', 'Geophysics', 'Astronomy', 'Planetary Science',
            'Environmental Science', 'Climate Change', 'Ecology', 'Conservation Biology',
            
            // Life Sciences & Medicine
            'Biology', 'Molecular Biology', 'Cell Biology', 'Genetics', 'Genomics',
            'Neuroscience', 'Psychology', 'Medicine', 'Clinical Research', 'Public Health',
            'Cancer Research', 'Pharmacology', 'Epidemiology', 'Biomedical Engineering',
            'Nutrition Science', 'Agricultural Science', 'Veterinary Science',
            
            // Mathematics & Statistics
            'Mathematics', 'Pure Mathematics', 'Applied Mathematics', 'Algebra',
            'Geometry', 'Calculus', 'Probability Theory', 'Mathematical Statistics',
            'Optimization Theory', 'Game Theory', 'Mathematical Modeling',
            
            // Engineering
            'Engineering', 'Mechanical Engineering', 'Civil Engineering', 'Electrical Engineering',
            'Aerospace Engineering', 'Environmental Engineering', 'Materials Engineering',
            'Renewable Energy', 'Robotics Engineering', 'Biotechnology',
            
            // Social Sciences
            'Sociology', 'Political Science', 'International Relations', 'Economics',
            'Anthropology', 'Archaeology', 'Geography', 'Urban Planning',
            'Criminology', 'Criminal Justice', 'Public Policy',
            
            // Humanities
            'History', 'Literature', 'Philosophy', 'Linguistics', 'Art', 'Music',
            'Religious Studies', 'Cultural Studies', 'Media Studies',
            
            // Education
            'Education', 'Educational Psychology', 'Learning Sciences', 'Curriculum Studies',
            'Educational Technology', 'Higher Education', 'Teacher Education',
            
            // Business & Management
            'Business Administration', 'Management', 'Marketing', 'Finance',
            'Entrepreneurship', 'International Business', 'Human Resource Management',
            
            // Law & Legal Studies
            'Law', 'Constitutional Law', 'Criminal Law', 'International Law',
            'Intellectual Property Law', 'Environmental Law', 'Legal Studies',
            
            // Research Methods & Skills
            'Research Methodology', 'Experimental Design', 'Survey Design',
            'Qualitative Research', 'Quantitative Research', 'Mixed Methods Research',
            'Academic Writing', 'Technical Writing', 'Grant Writing', 'Teaching',
            'Presentation Skills', 'Public Speaking', 'Mentoring', 'Collaboration',
            'Project Management', 'Innovation', 'Creativity', 'Problem Solving',
            'Critical Thinking', 'Analytical Skills', 'Research Skills',
            'Literature Review', 'Funding', 'Communication', 'Leadership'
        ];

        let selectedInterests = [];
        let availableInterests = [...researchInterests];

        // Achievements - Modal create
        function addAchievementWithModal() {
            const modalHTML = `
                <div id="addAchievementModal" class="custom-modal" style="display: flex;">
                    <div class="custom-modal-overlay" onclick="closeAchievementModal()"></div>
                    <div class="custom-modal-content">
                        <div class="custom-modal-header">
                            <h5 class="custom-modal-title"><i class="fas fa-trophy me-2"></i>Add Achievement</h5>
                            <button type="button" class="custom-modal-close" onclick="closeAchievementModal()">&times;</button>
                        </div>
                        <div class="custom-modal-body">
                            <form id="addAchievementForm">
                                <div class="mb-3">
                                    <label class="form-label">Title *</label>
                                    <input type="text" class="form-control" id="achievementTitle" required placeholder="e.g., Best Paper Award">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" id="achievementType">
                                        <option value="">Select type</option>
                                        <option value="Grant">Grant</option>
                                        <option value="Award">Award</option>
                                        <option value="Fund">Fund</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Year</label>
                                    <input type="number" class="form-control" id="achievementYear" min="1900" max="2100">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="achievementDescription" rows="3" placeholder="Optional description..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="custom-modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAchievementModal()">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitAchievement()">Add Achievement</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                const input = document.getElementById('achievementTitle');
                if (input) input.focus();
            }, 100);
        }

        function closeAchievementModal() {
            const modal = document.getElementById('addAchievementModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }

        function submitAchievement() {
            const form = document.getElementById('addAchievementForm');
            const formData = {
                title: document.getElementById('achievementTitle').value,
                type: document.getElementById('achievementType').value,
                year: document.getElementById('achievementYear').value,
                description: document.getElementById('achievementDescription').value
            };

            fetch('/add_achievement', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const list = document.getElementById('achievements-list');
                    const newItem = document.createElement('div');
                    newItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    newItem.dataset.achid = data.achievement.id;
                    newItem.style.cursor = 'move';
                    newItem.innerHTML = `
                        <div>
                            <strong>${data.achievement.title}</strong>
                            ${data.achievement.type ? `<span class="badge bg-secondary">${data.achievement.type}</span>` : ''}
                            ${data.achievement.year ? `<small class="text-muted">(${data.achievement.year})</small>` : ''}
                            ${data.achievement.description ? `<p class="mb-0 text-muted">${data.achievement.description}</p>` : ''}
                        </div>
                        <div>
                            <button class="btn btn-sm btn-danger" onclick="deleteAchievement('${data.achievement.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    list.prepend(newItem);
                    closeAchievementModal();
                    showNotification('Achievement added successfully!', 'success');
                } else {
                    showNotification('Error adding achievement', 'error');
                }
            })
            .catch(() => showNotification('Error adding achievement', 'error'));
        }



        // Test function - can be called from browser console
        function testModal() {
            console.log('Testing modal...');
            const modalElement = document.getElementById('editInterestsModal');
            if (modalElement) {
                console.log('Modal element found');
                modalElement.style.display = 'flex';
                console.log('Modal should be showing');
            } else {
                console.error('Modal element not found');
            }
        }

        // Show custom modal
        function showModal() {
            const modal = document.getElementById('editInterestsModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
        }

        // Close custom modal
        function closeModal() {
            const modal = document.getElementById('editInterestsModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
        }

        // Edit interests
        function editInterests() {
            console.log('Edit interests clicked');
            
            try {
                // Get current interests from the page
                const currentInterests = [];
                const interestTags = document.querySelectorAll('#research-interests .interest-tag');
                interestTags.forEach(tag => {
                    const interest = tag.textContent.trim();
                    // Skip the placeholder text
                    if (interest !== 'No interests selected yet') {
                        currentInterests.push(interest);
                    }
                });
                
                console.log('Current interests from page:', currentInterests);
                
                selectedInterests = [...currentInterests];
                availableInterests = researchInterests.filter(interest => 
                    !selectedInterests.includes(interest)
                );
                
                console.log('Selected interests:', selectedInterests);
                console.log('Available interests count:', availableInterests.length);
                
                updateInterestsDisplay();
                
                // Clear search input
                const searchInput = document.getElementById('interest-search');
                if (searchInput) {
                    searchInput.value = '';
                }
                
                initializeSearch();
                
                // Show modal
                showModal();
                console.log('Modal should be showing now');
                
            } catch (error) {
                console.error('Error in editInterests:', error);
                console.error('Error opening interests editor:', error);
            }
        }

        // Update interests display in modal
        function updateInterestsDisplay() {
            console.log('Updating interests display');
            const selectedContainer = document.getElementById('selected-interests-list');
            
            if (!selectedContainer) {
                console.error('Selected container not found');
                return;
            }
            
            // Clear selected container
            selectedContainer.innerHTML = '';
            
            console.log('Adding selected interests:', selectedInterests.length);
            // Add selected interests
            selectedInterests.forEach(interest => {
                const tag = document.createElement('span');
                tag.className = 'interest-tag selected-tag';
                tag.textContent = interest;
                tag.onclick = () => removeInterest(interest);
                selectedContainer.appendChild(tag);
            });
            
            // Update counter
            const counter = document.getElementById('selected-count');
            if (counter) {
                counter.textContent = selectedInterests.length;
            }
        }

        // Update search results
        function updateSearchResults(searchTerm) {
            const searchResultsDiv = document.getElementById('search-results');
            const searchResultsList = document.getElementById('search-results-list');
            
            if (!searchResultsDiv || !searchResultsList) {
                console.error('Search results elements not found');
                return;
            }
            
            // Clear previous results
            searchResultsList.innerHTML = '';
            
            if (searchTerm.length < 2) {
                searchResultsDiv.style.display = 'none';
                return;
            }
            
            // Filter interests based on search term
            const filteredInterests = researchInterests.filter(interest => 
                interest.toLowerCase().includes(searchTerm.toLowerCase()) &&
                !selectedInterests.includes(interest)
            );
            
            if (filteredInterests.length === 0) {
                searchResultsDiv.style.display = 'none';
                return;
            }
            
            // Show search results
            searchResultsDiv.style.display = 'block';
            
            // Add filtered interests
            filteredInterests.slice(0, 20).forEach(interest => { // Limit to 20 results
                const tag = document.createElement('span');
                tag.className = 'interest-tag available-tag';
                tag.textContent = interest;
                tag.onclick = () => addInterest(interest);
                searchResultsList.appendChild(tag);
            });
            
            if (filteredInterests.length > 20) {
                const moreTag = document.createElement('span');
                moreTag.className = 'interest-tag more-results';
                moreTag.textContent = `... and ${filteredInterests.length - 20} more`;
                moreTag.style.fontStyle = 'italic';
                moreTag.style.opacity = '0.7';
                searchResultsList.appendChild(moreTag);
            }
        }

        // Add interest
        function addInterest(interest) {
            console.log('Adding interest:', interest);
            if (!selectedInterests.includes(interest)) {
                selectedInterests.push(interest);
                updateInterestsDisplay();
                
                // Update search results to remove the added interest
                const searchInput = document.getElementById('interest-search');
                if (searchInput) {
                    updateSearchResults(searchInput.value);
                }
            }
        }

        // Remove interest
        function removeInterest(interest) {
            console.log('Removing interest:', interest);
            selectedInterests = selectedInterests.filter(i => i !== interest);
            updateInterestsDisplay();
            
            // Update search results to show the removed interest again
            const searchInput = document.getElementById('interest-search');
            if (searchInput) {
                updateSearchResults(searchInput.value);
            }
        }

        // Save interests
        function saveInterests() {
            console.log('Saving interests:', selectedInterests);
            
            // Update the page display
            const interestsContainer = document.getElementById('research-interests');
            interestsContainer.innerHTML = '';
            
            if (selectedInterests.length === 0) {
                const tag = document.createElement('span');
                tag.className = 'interest-tag';
                tag.textContent = 'No interests selected yet';
                interestsContainer.appendChild(tag);
            } else {
                selectedInterests.forEach(interest => {
                    const tag = document.createElement('span');
                    tag.className = 'interest-tag';
                    tag.textContent = interest;
                    interestsContainer.appendChild(tag);
                });
            }
            
            // Send to server
            const interestsString = selectedInterests.join(',');
            console.log('Sending to server:', interestsString);
            
            fetch('/update-interests', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    interests: interestsString
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Server response:', data);
                if (data.success) {
                    showNotification('Research interests updated successfully!', 'success');
                    closeModal();
                } else {
                    showNotification('Error updating interests. Please try again.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error updating interests. Please try again.', 'error');
            });
        }

        // Initialize search functionality when modal is shown
        function initializeSearch() {
            const searchInput = document.getElementById('interest-search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value;
                    updateSearchResults(searchTerm);
                });
            }
        }

        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;

            // Add to page
            document.body.appendChild(notification);

            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
{% endblock %}
